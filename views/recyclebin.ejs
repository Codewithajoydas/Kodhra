<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recycle Bin | Code Snippet Manager</title>
    <link rel="stylesheet" href="/style/css/partials/Header.css">
    <link rel="stylesheet" href="/style/css/ad_search.css">
    <link rel="stylesheet" href="/style/css/Notification.css">
    <link rel="stylesheet" href="/style/css/index.css">
    <link rel="stylesheet" href="/style/css/chip.css">
    <link rel="stylesheet" href="/style/css/card.css">
    <link rel="stylesheet" href="/style/css/folder.css">
    <link rel="stylesheet" href="/style/css/toast.css">
    <link rel="stylesheet" href="/style/css/loader.css">

    <script src="/socket.io/socket.io.js"></script>

    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="/assets/logo.webp" type="image/png" />
  
    <script src="https://cdn.jsdelivr.net/npm/@codewithajoydas/toastmaster@3.0.0/dist/toaster.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@codewithajoydas/toastmaster@3.0.0/dist/toaster.min.css">


</head>

<body data-theme="light">
    <%- include("partials/loader.ejs")%>
        <div class="content">
            <%- include("partials/header.ejs")%>
                <div class="container">
                    <%- include("partials/sidebar.ejs", { navigation: 'recyclebin' })%>
                        <main style="width: 100%; height: calc(100vh - 70px);">
                            <% if(card.length !==0 || folders.length !==0){%>
                                <% if(folders.length !==0){%>
                                    <div class="page_title" onclick="collapse(this)">
                                        <span class="down"><svg xmlns="http://www.w3.org/2000/svg" width="20"
                                                height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                class="lucide lucide-chevron-down-icon lucide-chevron-down">
                                                <path d="m6 9 6 6 6-6" />
                                            </svg></span>
                                        Deleted Folders
                                    </div>
                                    <section style="width: 100%;">
                                        <div id="folders"
                                            style="overflow-y: scroll !important; display: flex;flex-wrap: wrap;gap: 10px;margin: 10px;justify-content: center; padding-block:10px ;">
                                            <% folderData.forEach((folder, i)=> { %>
                                                <div class="folder" tabindex="0" data-id="<%= folder._id %>"
                                                    data-name="<%= folder.folderName %>" data-contextmenu="true"
                                                    data-menus="delete,  move, share, rename"
                                                    data-cardName="<%= folder.folderName %>" data-mtype="folder"
                                                    data-cardauthor="<%= folder.author._id %>"
                                                    data-userId="<%= userId %>"
                                                    style="flex: 1;min-width: 300px; max-width: 210px;display: flex;align-items: center;gap: 10px; padding: 10px;background: var(--bg-color);border-radius: 10px;justify-content: space-between; box-shadow: var(--box-shadow);">
                                                    <div
                                                        style="display: flex;justify-content: center;align-items: center;gap: 10px;">
                                                        <span><svg xmlns="http://www.w3.org/2000/svg" width="30"
                                                                height="30" viewBox="0 0 24 24" fill="#F7B31B"
                                                                stroke="currentColor" stroke-width=".1"
                                                                stroke-linecap="round" stroke-linejoin="round"
                                                                class="lucide lucide-folder-icon lucide-folder">
                                                                <path
                                                                    d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z" />
                                                            </svg></span><span
                                                            style="display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 130px;">
                                                            <%= folder.folderName%>
                                                        </span>
                                                    </div>
                                                    <div style="display: flex;align-items: center;gap: 10px;">
                                                        <% if(folder.isDeleted){%>
                                                            <div class="restore" style="--accent: #60df3abd"
                                                                data-tooltip="Restore">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="20"
                                                                    height="20" viewBox="0 0 24 24" fill="none"
                                                                    stroke="currentColor" stroke-width="2"
                                                                    stroke-linecap="round" stroke-linejoin="round"
                                                                    class="lucide lucide-rotate-ccw-icon lucide-rotate-ccw">
                                                                    <path
                                                                        d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                                                                    <path d="M3 3v5h5" />
                                                                </svg>
                                                            </div>
                                                            <% } %>
                                                                <div class="menu_top" data-menu-id="<%= folder._id %>"
                                                                    data-id="<%= folder._id %>"
                                                                    data-menus="delete, move, share, rename"
                                                                    onclick="openContextMenu(event)"
                                                                    data-userId="<%= userId %>"
                                                                    data-cardauthor="<%= folder.author._id %>"
                                                                    data-cardName="<%= folder.folderName %>"
                                                                    data-mtype="folder" data-contextMenu="true"
                                                                    tabindex="0">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20"
                                                                        height="20" viewBox="0 0 24 24" fill="none"
                                                                        stroke="currentColor" stroke-width="2"
                                                                        stroke-linecap="round" stroke-linejoin="round"
                                                                        class="lucide lucide-ellipsis-vertical-icon lucide-ellipsis-vertical">
                                                                        <circle cx="12" cy="12" r="1" />
                                                                        <circle cx="12" cy="5" r="1" />
                                                                        <circle cx="12" cy="19" r="1" />
                                                                    </svg>
                                                                </div>
                                                    </div>
                                                </div>
                                                <% })%>
                                        </div>
                                    </section>
                                    <%}%>

                                        <% if(card.length!==0){%>
                                            <div class="page_title" onclick="collapse(this)">
                                                <span class="down"><svg xmlns="http://www.w3.org/2000/svg" width="20"
                                                        height="20" viewBox="0 0 24 24" fill="none"
                                                        stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        class="lucide lucide-chevron-down-icon lucide-chevron-down">
                                                        <path d="m6 9 6 6 6-6" />
                                                    </svg></span>
                                                Deleted Snippets
                                            </div>
                                            <section>
                                                <div id="cards">
                                                    <% if (card.length===0) { %>
                                                        <%- include("partials/no-data.ejs") %>

                                                            <% } else { %>
                                                                <%- include("partials/cards") %>
                                                                    <% } %>
                                                </div>
                                                <% if(card.length!==0){%>
                                                    <div id="sentinal"
                                                        style="text-align: center; margin-block:10px; color: red;">
                                                        <img src="https://cdn.pixabay.com/animation/2024/04/02/07/57/07-57-40-974_512.gif"
                                                            alt="Loading..." style="width: 10%;">
                                                    </div>
                                                    <%}%>
                                            </section>
                                            <%}%>
                                                <%}else{%>
                                                    <div class="nodata"
                                                        style="height: calc(100vh - 100px);display: flex;justify-content: center;align-items: center;">
                                                        <%- include("partials/no-data.ejs") %>
                                                    </div>
                                                    <%}%>

                                                        <%- include("partials/fab")%>
                        </main>
                        <div class="notification-bar">
                            <h3>Notifications</h3>
                            <ul class="notification-lists">
                            </ul>
                        </div>
                        <div id="context_menu"
                            style="position: absolute;top: 0;left: 0;display: none;z-index: 1000000;width: 200px;">
                            <ul id="context_menu_list"></ul>
                        </div>



                        <div class="notification-bar">
                            <h3>Notifications</h3>
                            <ul class="notification-lists">
                            </ul>
                        </div>



                        <div class="networkInfo" style="display: none;">
                            <span><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" class="lucide lucide-info-icon lucide-info">
                                    <circle cx="12" cy="12" r="10" />
                                    <path d="M12 16v-4" />
                                    <path d="M12 8h.01" />
                                </svg></span>

                            <span id="networkInfo"></span>
                        </div>
                        <div class="move_folder">
                            <div class="header_title" style="font-weight: bolder">
                                <div class="span">Move " folderName"</div>
                            </div>
                            <hr />
                            <div class="folders_name">
                                <ul>
                                    <% if (folders.length===0) { %>
                                        <span style="margin: 10px; color: red">No folder found</span>
                                        <% } %>
                                            <% folders.forEach((folder, i)=> { %>
                                                <li>
                                                    <label>
                                                        <input type="radio" name="moveFolder" value="<%= folder._id %>"
                                                            id="moveFolder<%= i %>" />
                                                        <div class="folder">
                                                            <div class="folder_icon">
                                                                <!-- SVG folder icon -->
                                                            </div>
                                                            <div class="folder_name" style="
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    gap: 10px;
                  ">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                                                    height="24" viewBox="0 0 24 24" fill="#EDCE44"
                                                                    stroke="none" stroke-width="2"
                                                                    stroke-linecap="round" stroke-linejoin="round"
                                                                    class="lucide lucide-folder-icon lucide-folder">
                                                                    <path
                                                                        d="m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2" />
                                                                </svg>
                                                                <span style="
                      display: block;
                      width: 120px;
                      white-space: nowrap;
                      overflow: hidden;
                      text-overflow: ellipsis;
                    " title="<%= folder.folderName %>">
                                                                    <%= folder.folderName %>
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </li>
                                                <% }) %>
                                </ul>
                                <button class="move_btn" onclick="moveIt()" <%=folders.length===0 ? "disabled" : "" %> >
                                    Move </button>
                            </div>
                        </div>

                </div>
        </div>



        <script src="/scripts/ad_search.js"></script>
        <script src="/scripts/Fab.js"></script>
        <script src="/scripts/Notification.js"></script>
        <script src="/scripts/searchFunction.js"></script>
        <script src="/scripts/context_menu.js"></script>
        <script src="\scripts\isonline.js"></script>
        <script src="/scripts/header.js"></script>

        <script>
            let cardsContainer = document.getElementById("cards");
            let sentinalv2 = document.getElementById("sentinal");
            let currentPage = 1;
            const observerA = new IntersectionObserver(async (entries) => {
                for (let entry of entries) {
                    if (entry.isIntersecting) {
                        currentPage++;
                        const res = await fetch(`/pin/json?page=${currentPage}`);
                        if (res.ok) {
                            const html = await res.text();
                            if (html.trim()) {
                                cardsContainer.insertAdjacentHTML("beforeend", html);
                            } else {
                                if (sentinalv2) {
                                    sentinalv2.textContent = "All caught up!... ";
                                    observerA.unobserve(sentinalv2);
                                }
                            }
                        }
                    }
                }
            }, {
                threshold: 0
            });
            if (sentinalv2) {
                observerA.observe(sentinalv2);
            }
        </script>


        <script>
            const containera = document.querySelector("#cards");
            containera.addEventListener("change", () => {
                updateSelectedCards();
            });

            const onDocumentChange = (mutationsList, observer) => {
                for (const mutation of mutationsList) {
                    if (mutation.type === 'childList') {
                    } else if (mutation.type === 'attributes') {
                    }
                }
            };

            const config = {
                attributes: true,
                childList: true,
                subtree: true
            };

            const observers = new MutationObserver(onDocumentChange);

            if (containera) {
                observers.observe(containera, config);
            }
            let selectedCardsSet = new Set();




            function updateSelectedCards() {

                const selectedcards = document.querySelectorAll(".select-card");
                selectedcards.forEach(e => {
                    const id = e.closest("[data-id]").dataset.id;
                    if (e.checked) {
                        selectedCardsSet.add(id);
                    } else {
                        selectedCardsSet.delete(id);
                    }
                });
                let cardlen = document.querySelector(".cardLen");
                cardlen.textContent = [...selectedCardsSet].length
                if ([...selectedCardsSet].length > 0) {
                    document.querySelector(".card-options").classList.remove("disabled");
                } else {
                    document.querySelector(".card-options").classList.add("disabled");
                }
            }
            updateSelectedCards();


            function selectAllButton() {
                const selectedcards = document.querySelectorAll(".select-card");
                const shouldSelect = !Array.from(selectedcards).every(cb => cb.checked);

                selectedcards.forEach(cb => cb.checked = shouldSelect);
                updateSelectedCards();
            }

            async function deleteCards() {
                if (selectedCardsSet.size > 0) {
                    try {
                        const res = await fetch("/card/delete", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                selected: [...selectedCardsSet]
                            })
                        });
                        if (res.ok) {
                            location.reload();
                        }
                    } catch (error) {
                        console.error("Error deleting cards:", error);
                        showToast("üö® Unexpected error. Please check your connection.", "error");
                    }
                } else {
                    showToast("‚ö†Ô∏è Please select cards before deleting.", "error");
                }
            }

            async function downloadCard() {
                try {
                    if (selectedCardsSet.size > 1) {
                        const res = await fetch("/card/download", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                selected: [...selectedCardsSet]
                            })
                        });
                        if (res.ok) {
                            let data = await res.json();
                            const blob = new Blob([JSON.stringify({ ...data })], { type: "application/json" });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement("a");
                            a.href = url;
                            const date = new Date().toLocaleDateString();
                            const time = new Date().toLocaleTimeString();
                            a.download = `Snippets-${date}-${time}.json`;
                            a.click();
                            URL.revokeObjectURL(url);
                        } else {
                            console.error("Somthing went wrong...")
                        }
                    } else {
                        showToast("‚ö†Ô∏è Please select minimum 2 cards before downloading.", "error");
                    }
                } catch (error) {
                    console.error(error.message);
                }
            }

        </script>
        <script src="\scripts\shortcut.js"></script>
        <script src="\scripts\collapse.js"></script>




        <script>
            document.addEventListener("click", (e) => {
                try {
                    if (e.target.closest(".restore")) {
                        const id = e.target.closest("[data-id]").dataset.id;
                        const mtype = e.target.closest("[data-mtype]").dataset.mtype;
                        fetch(`/recyclebin/${mtype}/${id}`, { method: "PUT" }).then(res => location.reload());
                    }
                } catch (error) {
                    console.log(error)
                }
            })
        </script>
</body>

</html>